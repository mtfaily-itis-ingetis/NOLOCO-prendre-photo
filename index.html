<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prendre une photo</title>
  <style>
    :root{--card:#fff;--bg:#f6f7f9}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg)}
    .wrap{max-width:520px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    h1{font-size:20px;margin:0 0 6px}
    .muted{color:#6b7280;font-size:13px}
    .idline{margin:6px 0 12px}
    video, img{width:100%;border-radius:12px;background:#000}
    canvas{display:none}
    .row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    button{flex:1;padding:12px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .primary{background:#0a84ff;color:#fff}
    .secondary{background:#e6e8eb}
    .hidden{display:none}
    .ok{color:#0b8a00}.err{color:#b00020}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Prendre une photo</h1>
      <p class="idline">ID détecté : <strong id="rid">—</strong></p>

      <video id="video" autoplay playsinline muted></video>
      <img id="preview" class="hidden" alt="aperçu" />
      <canvas id="canvas"></canvas>

      <div class="row">
        <button id="btnStart" class="secondary hidden">Autoriser la caméra</button>
        <button id="btnCapture" class="primary">Capturer</button>
        <button id="btnRetake" class="secondary hidden">Reprendre</button>
        <button id="btnSend" class="primary hidden">Envoyer</button>
      </div>

      <input id="fileInput" type="file" accept="image/*" capture="environment" class="hidden" />

      <p id="status" class="muted" style="margin-top:10px"></p>
      <p class="muted">Astuce : sur iPhone, touchez d’abord un bouton si la caméra ne démarre pas automatiquement.</p>
    </div>
  </div>

  <script>
    // --- Lecture de l'ID dans l'URL ---
    const qs = new URLSearchParams(location.search);
    const recordId = qs.get("recordId") || "";
    document.getElementById("rid").textContent = recordId || "(aucun — ajoutez ?recordId=...)";

    // --- Éléments UI ---
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("preview");
    const btnStart = document.getElementById("btnStart");
    const btnCapture = document.getElementById("btnCapture");
    const btnRetake = document.getElementById("btnRetake");
    const btnSend = document.getElementById("btnSend");
    const fileInput = document.getElementById("fileInput");
    const status = document.getElementById("status");

    let stream = null;
    let lastDataUrl = null;

    // --- Démarrer la caméra ---
    async function startCamera() {
      status.textContent = "Initialisation de la caméra…";
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        status.textContent = "Caméra prête.";
        btnStart.classList.add("hidden");
      } catch (e) {
        status.innerHTML = "❗ Impossible de démarrer la caméra (" + e.message + "). Utilisez l’icône de caméra du navigateur ou le bouton ci-dessus.";
        btnStart.classList.remove("hidden");
      }
    }

    // Démarrer automatiquement (si le navigateur l'autorise)
    startCamera();
    btnStart.addEventListener("click", startCamera);

    // --- Capturer une image depuis la vidéo ---
    function captureFrameToDataURL() {
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);
      return canvas.toDataURL("image/jpeg", 0.9);
    }

    btnCapture.addEventListener("click", async () => {
      // Si pas de flux (iOS sans geste), on déclenche le fallback file input
      if (!stream || !stream.active) {
        fileInput.click();
        return;
      }
      lastDataUrl = captureFrameToDataURL();
      preview.src = lastDataUrl;
      preview.classList.remove("hidden");
      video.classList.add("hidden");
      btnRetake.classList.remove("hidden");
      btnSend.classList.remove("hidden");
      btnCapture.classList.add("hidden");
      status.textContent = "Aperçu prêt. Vous pouvez Reprendre ou Envoyer.";
    });

    // Fallback : si l’utilisateur choisit une photo via le file input (mobile)
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        lastDataUrl = reader.result;
        preview.src = lastDataUrl;
        preview.classList.remove("hidden");
        video.classList.add("hidden");
        btnRetake.classList.remove("hidden");
        btnSend.classList.remove("hidden");
        btnCapture.classList.add("hidden");
        status.textContent = "Aperçu prêt (fichier choisi).";
      };
      reader.readAsDataURL(file);
    });

    // --- Reprendre ---
    btnRetake.addEventListener("click", () => {
      preview.classList.add("hidden");
      video.classList.remove("hidden");
      btnRetake.classList.add("hidden");
      btnSend.classList.add("hidden");
      btnCapture.classList.remove("hidden");
      status.textContent = "Caméra active.";
    });

    // --- Arrêt caméra ---
    function stopCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
    }

    // --- Fermeture intelligente de l’onglet ---
    function smartClose() {
      // 1) Si dans un iframe (ex: Noloco), demander au parent de fermer
      try {
        if (window.top !== window.self) {
          parent.postMessage({ type: "noloco-close-request", recordId }, "*");
        }
      } catch {}

      // 2) Essayer de fermer l'onglet (autorisé si ouvert via window.open)
      try { window.opener = null; } catch {}
      window.close();

      // 3) Fallback : revenir en arrière s'il y a un historique
      if (history.length > 1) {
        history.back();
        return;
      }

      // 4) Fallback final : vider l'onglet
      location.replace("about:blank");
    }

    // --- Envoyer (pour l’instant : affiche l’ID puis ferme) ---
    btnSend.addEventListener("click", () => {
      if (!lastDataUrl) { status.textContent = "Prenez d’abord une photo."; return; }
      stopCamera();
      alert("ID (test) : " + (recordId || "(aucun)"));
      smartClose();
    });
  </script>
</body>
</html>
