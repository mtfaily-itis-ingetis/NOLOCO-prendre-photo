<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prendre une photo</title>
  <style>
    /* Layout: full-screen camera with minimal chrome */
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .stage{position:fixed;inset:0;height:100dvh;width:100vw;overflow:hidden;background:#000}
    video, img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
    canvas{display:none}

    /* Bottom gradient for readability of controls */
    .bottom-fade{position:absolute;left:0;right:0;bottom:0;height:32dvh;
      background:linear-gradient(180deg,rgba(0,0,0,0) 0%,rgba(0,0,0,.55) 60%,rgba(0,0,0,.9) 100%);
      pointer-events:none}

    /* Controls */
    .controls{position:absolute;left:0;right:0;bottom:calc(env(safe-area-inset-bottom) + 18px);
      display:flex;justify-content:center;align-items:center;gap:12px;padding:0 16px;z-index:5}
    .pill{padding:12px 16px;border:0;border-radius:999px;font-weight:700;cursor:pointer}
    .primary{background:#0a84ff;color:#fff}
    .neutral{background:rgba(255,255,255,.9);color:#111}
    .ghost{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.35)}
    .shutter{
      width:78px;height:78px;border-radius:50%;border:6px solid rgba(255,255,255,.85);
      background:rgba(255,255,255,.92);cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.35)
    }
    .row{display:flex;gap:10px;align-items:center}
    .hidden{display:none !important}

    /* Center message/button if camera blocked */
    .center-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:6}
    .center-card{background:rgba(0,0,0,.55);backdrop-filter:blur(6px);padding:18px 20px;border-radius:12px;color:#fff}
    .center-card button{margin-top:10px}

    /* Small helper button (optional flip/fallback) */
    .tools{position:absolute;top:calc(env(safe-area-inset-top) + 12px);right:12px;z-index:6;display:flex;gap:8px}
    .toolbtn{padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.35);background:rgba(0,0,0,.35);color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <main class="stage">
    <video id="video" autoplay playsinline muted></video>
    <img id="preview" class="hidden" alt="aperçu" />
    <canvas id="canvas"></canvas>

    <!-- Small utility area (kept minimal) -->
    <div class="tools">
      <button id="btnStart" class="toolbtn hidden">Activer la caméra</button>
    </div>

    <div class="bottom-fade" aria-hidden="true"></div>

    <!-- Live controls (before capture) -->
    <div id="liveControls" class="controls">
      <button id="btnCapture" class="shutter" aria-label="Capturer"></button>
    </div>

    <!-- Review controls (after capture) -->
    <div id="reviewControls" class="controls hidden">
      <div class="row">
        <button id="btnRetake" class="pill neutral">Reprendre</button>
        <button id="btnSend" class="pill primary">Envoyer</button>
      </div>
    </div>

    <!-- Fallback file input for browsers that block getUserMedia without a gesture -->
    <input id="fileInput" type="file" accept="image/*" capture="environment" class="hidden" />
    
    <!-- If permission denied, show a central prompt -->
    <div id="blocked" class="center-overlay hidden">
      <div class="center-card">
        <div>Autorise l’accès à la caméra pour continuer.</div>
        <button id="btnTryAgain" class="pill primary">Réessayer</button>
      </div>
    </div>
  </main>

  <script>
    // --- Read recordId silently (kept for webhook use later) ---
    const qs = new URLSearchParams(location.search);
    const recordId = qs.get("recordId") || "";

    // --- Elements ---
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const preview = document.getElementById("preview");
    const liveControls = document.getElementById("liveControls");
    const reviewControls = document.getElementById("reviewControls");
    const btnStart = document.getElementById("btnStart");
    const btnCapture = document.getElementById("btnCapture");
    const btnRetake = document.getElementById("btnRetake");
    const btnSend = document.getElementById("btnSend");
    const fileInput = document.getElementById("fileInput");
    const blocked = document.getElementById("blocked");
    const btnTryAgain = document.getElementById("btnTryAgain");

    let stream = null;
    let lastDataUrl = null;

    // --- Start camera ---
    async function startCamera() {
      blocked.classList.add("hidden");
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        btnStart.classList.add("hidden");
      } catch (e) {
        // Show unobtrusive prompt to try again or use fallback
        btnStart.classList.remove("hidden");
        blocked.classList.remove("hidden");
      }
    }
    startCamera();
    btnStart.addEventListener("click", startCamera);
    btnTryAgain.addEventListener("click", startCamera);

    // --- Capture frame from video ---
    function captureFrameToDataURL() {
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);
      return canvas.toDataURL("image/jpeg", 0.9);
    }

    // --- Live → Review ---
    function enterReview(dataUrl) {
      lastDataUrl = dataUrl;
      preview.src = lastDataUrl;
      preview.classList.remove("hidden");
      video.classList.add("hidden");
      liveControls.classList.add("hidden");
      reviewControls.classList.remove("hidden");
    }

    // --- Review → Live ---
    function backToLive() {
      preview.classList.add("hidden");
      video.classList.remove("hidden");
      reviewControls.classList.add("hidden");
      liveControls.classList.remove("hidden");
    }

    // Capture button
    btnCapture.addEventListener("click", () => {
      if (!stream || !stream.active) { fileInput.click(); return; }
      enterReview(captureFrameToDataURL());
    });

    // Fallback file chooser (mobile / strict browsers)
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => enterReview(reader.result);
      reader.readAsDataURL(file);
    });

    // Retake
    btnRetake.addEventListener("click", backToLive);

    // Stop camera
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    // Smart close
    function smartClose() {
      try { if (window.top !== window.self) parent.postMessage({ type:"noloco-close-request", recordId }, "*"); } catch {}
      try { window.opener = null; } catch {}
      window.close();
      if (history.length > 1) { history.back(); return; }
      location.replace("about:blank");
    }

    // Send (for now: show ID, then close)
    btnSend.addEventListener("click", () => {
      if (!lastDataUrl) return;
      stopCamera();
      alert("ID (test) : " + (recordId || "(aucun)"));
      smartClose();
    });
  </script>
</body>
</html>
